name: ğŸ§¹ Clean AdGuardHome Blocklist

on:
  schedule:
    - cron: "0 0,6,12,18 * * *"  # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:              # æ‰‹åŠ¨è§¦å‘æ”¯æŒ

permissions:
  contents: write                 # å…è®¸å·¥ä½œæµæ¨é€æ›´æ”¹

jobs:
  clean-blocklist:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install dnspython

      - name: ğŸ§¹ Run blocklist cleaner
        run: |
          echo "ğŸš€ å¼€å§‹æ¸…ç† AdGuardHome blocklist ..."
          python3 clean_blocklist.py

      - name: ğŸ“Š Show summary
        run: |
          echo "âœ… æœ‰æ•ˆè§„åˆ™æ•°ï¼š$(wc -l < blocklist_valid.txt)"
          echo "ğŸ—‘ï¸ åˆ é™¤è§„åˆ™æ•°ï¼š$(wc -l < deleted_rules.log || echo 0)"

      - name: ğŸ’¾ Commit & Push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add blocklist_valid.txt deleted_rules.log || true
          if git diff --cached --quiet; then
            echo "ğŸŸ¢ æ— å˜åŒ–ï¼Œæ— éœ€æäº¤ã€‚"
          else
            git commit -m "Auto-clean: update valid blocklist $(date '+%Y-%m-%d %H:%M:%S')"
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main
            echo "âœ… å·²æ¨é€æ›´æ–°è‡³ä»“åº“ã€‚"
          fi
